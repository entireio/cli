Implement the following plan:

# ENT-242: Replace go-git worktree.Status() with git CLI shim

## Context

go-git v5's `worktree.Status()` reads **and rewrites** the worktree index file. When called from git hook paths (post-commit, prepare-commit-msg), this rewrites the index with stale cache-tree entries that reference objects pruned by GC, causing index corruption (`fatal: unable to read <sha>`). Confirmed via instrumentation showing post-commit hook changes the index checksum.

The fix: route all `worktree.Status()` calls through a shim that uses git CLI (`git status --porcelain`), which reads the index without rewriting it. The shim provides a single swap point for when go-git v6 fixes the bug.

## Approach

Create a new file `strategy/worktree_status.go` with two shim functions that return go-git types. All 10 call sites switch to use these shims.

### New file: `cmd/entire/cli/strategy/worktree_status.go`

Two exported functions:

1. **`WorktreeStatus(repo *git.Repository) (git.Status, error)`**
   - Parses `git status --porcelain -z` (NUL-delimited, handles special chars)
   - Returns `git.Status` (= `map[string]*git.FileStatus`) with `Staging` and `Worktree` fields populated
   - Maps porcelain XY codes to `git.StatusCode` values
   - Handles renames/copies (R/C have two NUL-separated entries)
   - `repo` param used to get worktree root for `cmd.Dir`; also makes future swap-back trivial
   - Status code mapping: `' '→Unmodified, M→Modified, A→Added, D→Deleted, R→Renamed, C→Copied, ?→Untracked, U→UpdatedButUnmerged, T→Modified`

2. **`StagedFileNames(repo *git.Repository) ([]string, error)`**
   - Uses `git diff --cached --name-only -z` (lightweight, staging-only query)
   - Returns just file names, no status parsing
   - Used by `getStagedFiles()` which only needs names

Both functions include a swap-back comment:
```go
// When go-git v6 fixes index corruption (ENT-242), swap to:
//   w, _ := repo.Worktree(); return w.Status()
```

### New file: `cmd/entire/cli/strategy/worktree_status_test.go`

Test the porcelain parsing logic:
- Standard modified/added/deleted/untracked entries
- Rename entries (two NUL-separated paths)
- Mixed staged + worktree changes
- Empty output (clean worktree)

### Call site updates (10 sites)

**`strategy/` package (4 sites) — use directly:**

| File | Line | Function | Change |
|------|------|----------|--------|
| `manual_commit_hooks.go` | 982 | `getStagedFiles()` | Replace body with `StagedFileNames(repo)` |
| `manual_commit_hooks.go` | 936 | `calculatePromptAttributionAtStart()` | `worktree.Status()` → `WorktreeStatus(repo)` |
| `common.go` | 667 | `checkCanRewind()` | `worktree.Status()` → `WorktreeStatus(repo)` |
| `common.go` | 733 | `checkCanRewindWithWarning()` | `worktree.Status()` → `WorktreeStatus(repo)` |

**`cli/` package (6 sites) — call via `strategy.WorktreeStatus()`:**

| File | Line | Function | Change |
|------|------|----------|--------|
| `state.go` | 214 | `ComputeFileChanges()` | `worktree.Status()` → `strategy.WorktreeStatus(repo)` |
| `state.go` | 283 | `ComputeDeletedFiles()` | `worktree.Status()` → `strategy.WorktreeStatus(repo)` |
| `state.go` | 344 | `getUntrackedFilesForState()` | `worktree.Status()` → `strategy.WorktreeStatus(repo)` |
| `state.go` | 546 | `DetectChangedFiles()` | `worktree.Status()` → `strategy.WorktreeStatus(repo)` |
| `rewind.go` | 1144 | `checkResetSafety()` | `worktree.Status()` → `strategy.WorktreeStatus(repo)` |
| `debug.go` | 295 | `getFileChanges()` | `worktree.Status()` → `strategy.WorktreeStatus(repo)` |

**Note:** Callers that still need `repo.Worktree()` for other purposes (e.g., `calculatePromptAttributionAtStart` reads `worktree.Filesystem.Root()`) keep that call — only the `.Status()` part is replaced.

### Reference implementation

`checkpoint/temporary.go:collectChangedFiles()` (line 1028) already parses `git status --porcelain -z` with full rename/copy handling. The shim's parsing logic follows the same pattern but returns `git.Status` instead of `changedFilesResult`.

## Verification

```bash
mise run fmt && mise run lint && mise run test:ci
```

Plus manual verification: confirm the shim doesn't rewrite the index by checking `md5 .git/index` before and after a hook invocation.


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/alex/.REDACTED.jsonl

---

[Request interrupted by user]

---

um, sorry, I should have mentioned this earlier - we did do a get status replacement for a different reason - shadow file tracking - is this reusable?

---

yeah that was the one `checkpoint/temporary.go:collectChangedFiles`. continue then

---

Base directory for this skill: /Users/alex/.claude/plugins/cache/claude-plugins-official/superpowers/4.2.0/skills/requesting-code-review

# Requesting Code Review

Dispatch superpowers:code-reviewer subagent to catch issues before they cascade.

**Core principle:** Review early, review often.

## When to Request Review

**Mandatory:**
- After each task in subagent-driven development
- After completing major feature
- Before merge to main

**Optional but valuable:**
- When stuck (fresh perspective)
- Before refactoring (baseline check)
- After fixing complex bug

## How to Request

**1. Get git SHAs:**
```bash
BASE_SHA=$(git rev-parse HEAD~1)  # or origin/main
HEAD_SHA=$(git rev-parse HEAD)
```

**2. Dispatch code-reviewer subagent:**

Use Task tool with superpowers:code-reviewer type, fill template at `code-reviewer.md`

**Placeholders:**
- `{WHAT_WAS_IMPLEMENTED}` - What you just built
- `{PLAN_OR_REQUIREMENTS}` - What it should do
- `{BASE_SHA}` - Starting commit
- `{HEAD_SHA}` - Ending commit
- `{DESCRIPTION}` - Brief summary

**3. Act on feedback:**
- Fix Critical issues immediately
- Fix Important issues before proceeding
- Note Minor issues for later
- Push back if reviewer is wrong (with reasoning)

## Example

```
[Just completed Task 2: Add verification function]

You: Let me request code review before proceeding.

BASE_SHA=$(git log --oneline | grep "Task 1" | head -1 | awk '{print }')
HEAD_SHA=$(git rev-parse HEAD)

[Dispatch superpowers:code-reviewer subagent]
  WHAT_WAS_IMPLEMENTED: Verification and repair functions for conversation index
  PLAN_OR_REQUIREMENTS: Task 2 from docs/plans/deployment-plan.md
  BASE_SHA: a7981ec
  HEAD_SHA: 3df7661
  DESCRIPTION: Added verifyIndex() and repairIndex() with 4 issue types

[Subagent returns]:
  Strengths: Clean architecture, real tests
  Issues:
    Important: Missing progress indicators
    Minor: Magic number (100) for reporting interval
  Assessment: Ready to proceed

You: [Fix progress indicators]
[Continue to Task 3]
```

## Integration with Workflows

**Subagent-Driven Development:**
- Review after EACH task
- Catch issues before they compound
- Fix before moving to next task

**Executing Plans:**
- Review after each batch (3 tasks)
- Get feedback, apply, continue

**Ad-Hoc Development:**
- Review before merge
- Review when stuck

## Red Flags

**Never:**
- Skip review because "it's simple"
- Ignore Critical issues
- Proceed with unfixed Important issues
- Argue with valid technical feedback

**If reviewer wrong:**
- Push back with technical reasoning
- Show code/tests that prove it works
- Request clarification

See template at: requesting-code-review/code-reviewer.md

---

commit this, push, open draft PR.

then wait until the bugbot check has returned and /github-pr-review

---

[Request interrupted by user for tool use]

---

actually....before we go any further.... have a look at /tmp/entire-index-debug.log

I think that 16:42 post-commit was from here

if that's the case the bug is still live, no?

can we test a commit and see if the md5 moves?

---

I just copied the built binary from here to the one on the path - check the version if you will

---

Base directory for this skill: /Users/alex/.claude/skills/github-pr-review

# GitHub PR Review

## Overview

Technical mechanics for GitHub PR review workflows via `gh` CLI. Covers fetching review comments, replying to threads, creating/updating PRs.

**Companion skill:** For *how to evaluate* feedback, see `superpowers:receiving-code-review`. This skill covers *how to interact* with GitHub.

**Security:** Use fine-grained PAT with minimal permissions.

## Setup (One-Time)

### Fine-Grained PAT

Create at github.com -> Settings -> Developer settings -> Personal access tokens -> Fine-grained tokens:

| Permission | Level |
|------------|-------|
| Pull requests | Read & Write |
| Contents | Read |

**Can't:** Delete repos, push code, delete branches, manage settings.

### Configure & Allowlist

```bash
export GH_TOKEN="github_pat_xxxx"
```

Add to `.claude/settings.json`:
```json
{
  "permissions": {
    "allow": [
      "Bash(gh repo view:*)",
      "Bash(gh pr view:*)",
      "Bash(gh pr create:*)",
      "Bash(gh pr ready:*)",
      "Bash(gh pr edit:*)",
      "Bash(gh api repos/*/*/pulls/*/comments:*)",
      "Bash(gh api repos/*/*/pulls/*/comments/*/replies:*)"
    ]
  }
}
```

## Quick Reference

| Operation | Command |
|-----------|---------|
| Get owner/repo | `gh repo view --json owner,name -q '"\(.owner.login)/\(.name)"'` |
| Get PR number | `gh pr view --json number -q .number` |
| Get PR author | `gh pr view --json author -q .author.login` |
| Fetch all review comments | `gh api repos/{owner}/{repo}/pulls/{pr}/comments --paginate` |
| Get single comment | `gh api repos/{owner}/{repo}/pulls/comments/{comment_id}` |
| Reply to comment | `gh api repos/{owner}/{repo}/pulls/{pr}/comments/{comment_id}/replies -f body="msg"` |
| Create PR | `gh pr create --title "T" --body "B" [--draft]` |
| Mark ready | `gh pr ready [number]` |
| Convert to draft | `gh pr ready --undo [number]` |
| Edit PR | `gh pr edit [number] --title "T" --body "B"` |

## Workflow: Respond to PR Review

### 1. Get repo info and PR details

```bash
owner_repo=$(gh repo view --json owner,name -q '"\(.owner.login)/\(.name)"')
pr_number=$(gh pr view --json number -q .number)
pr_author=$(gh pr view --json author -q .author.login)
```

### 2. Fetch and analyze threads

```bash
# Fetch all comments and group into threads, showing last author per thread
gh api repos/${owner_repo}/pulls/${pr_number}/comments --paginate | jq 'sort_by([.in_reply_to_id // .id, .created_at]) | group_by(.in_reply_to_id // .id) | map({thread_id: (.[0].in_reply_to_id // .[0].id), path: .[0].path, line: (.[0].line // .[0].original_line), last_author: .[-1].user.login, last_body: .[-1].body[0:100], count: length})'
```

### 3. Filter to threads needing response

```bash
# Filter to threads where last_author != PR author
# Note: Use '| not' instead of '!=' to avoid shell escaping issues with !
... | jq --arg author "$pr_author" '[.[] | select(.last_author == $author | not)]'
```

For each thread needing response:
- Read the comment + file/line context
- Apply `superpowers:receiving-code-review` skill for evaluation
- Fix code and/or reply to thread

### 4. Commit fixes and push
- run the build, tests, linting as required
- commit the changes, noting the commit sha
- push the changes so they're visible
- We need to do this FIRST so we have the commit shas to put into the replies to the pr review

### 5. Re-fetch comment IDs (if rebased)

**Important:** If you rebased or force-pushed, comment IDs may have changed. Re-fetch the comment threads before replying:

```bash
gh api repos/${owner_repo}/pulls/${pr_number}/comments --paginate | jq '...'
```

### 6. Reply to a thread

```bash
gh api repos/${owner_repo}/pulls/${pr_number}/comments/{comment_id}/replies \
  -f body="Fixed in commit abc123. [description of fix]"
```

### 7. Summarize and finish

After all threads addressed, ask if ready to mark PR ready for review.

**Note:** REST API doesn't expose "resolved" status. We infer "done" when PR author made last comment in thread.

## Common Mistakes

| Mistake | Fix |
|---------|-----|
| Broad PAT permissions | Use fine-grained PAT with only Pull requests + Contents |
| Missing pagination | Always use `--paginate` for comment fetching |
| Top-level reply | Use `/comments/{id}/replies` endpoint, not `/comments` |
| Re-responding to threads | Skip threads where PR author made last comment |
| Forgetting to reply after fix | Always reply to confirm the fix was made |
| jq `!=` fails with shell error | Use `select(.x == "y" \| not)` instead of `select(.x != "y")` |
| 404 on reply after rebase | Comment IDs change after force-push/rebase. Re-fetch comments before replying |

ARGUMENTS: 171