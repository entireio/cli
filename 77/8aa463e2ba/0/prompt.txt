Implement the following plan:

# Entire Wingman - Implementation Plan

## Context

The wingman feature adds an automated code review loop to the CLI. After an agent turn that modifies files, a background reviewer analyzes the changes (using checkpoint data to understand intent), writes suggestions to `.entire/REVIEW.md`, and then — after a short delay — triggers the main agent to apply those suggestions via `claude --continue -p`. This creates a self-improving development loop where agent output gets automatically reviewed and refined.

## Architecture Overview

```
Agent turn ends (stop hook)
    │
    ├── SaveChanges (existing)
    ├── transitionSessionTurnEnd (existing)
    └── [NEW] If wingman enabled && files changed && no pending REVIEW.md && not already reviewed:
        │
        └── Spawn detached: `entire wingman __review <json>`
            │
            ├── Sleep ~10s (let agent turn fully settle)
            ├── git diff HEAD (get code changes)
            ├── Read user prompts from payload (for intent)
            ├── claude --print --model sonnet (review)
            ├── Write .entire/REVIEW.md
            └── Wait ~30s, then if session still IDLE:
                └── claude --continue -p "Apply .entire/REVIEW.md" --setting-sources ""
                    │
                    └── Agent applies suggestions, deletes REVIEW.md
                        (no hooks fire due to --setting-sources "",
                         so no infinite loop)
```

## Implementation Steps

### 1. Settings support

**File: `cmd/entire/cli/settings/settings.go`**

Add `IsWingmanEnabled()` method + package-level convenience function, following the `IsSummarizeEnabled()` pattern. Settings path: `strategy_options.wingman.enabled`.

### 2. `entire wingman` command group

**New file: `cmd/entire/cli/wingman.go`**

Cobra command group with subcommands:
- `entire wingman enable` — Sets `strategy_options.wingman.enabled = true` in settings. Validates Entire is enabled first.
- `entire wingman disable` — Sets it to `false`. Deletes `.entire/REVIEW.md` if present.
- `entire wingman status` — Shows enabled state + last review timestamp from `.entire/wingman-state.json`.

**File: `cmd/entire/cli/root.go`** — Register `newWingmanCmd()`.

### 3. Hidden `__review` command (detached worker)

**Within `cmd/entire/cli/wingman.go`** (or separate `wingman_review.go`):

Hidden command: `entire wingman __review <json-payload>`

Steps:
1. Unmarshal `WingmanPayload` (session ID, repo root, modified/new/deleted files, user prompts, commit message)
2. `cd` to repo root
3. **Initial delay**: Sleep ~10s to let the agent turn fully settle
4. Compute diff: `git diff HEAD` for uncommitted changes, or `git diff HEAD~1 HEAD` if auto-commit strategy just committed
5. Build review prompt (diff + prompts + file list)
6. Call `claude --print --model sonnet --output-format json --setting-sources ""` with prompt via stdin (reuse `stripGitEnv` pattern from `summarize/claude.go`, run from `os.TempDir()`)
7. Parse response, extract review text
8. Write `.entire/REVIEW.md`
9. Update `.entire/wingman-state.json` (dedup tracking)
10. **Auto-apply phase**: Sleep ~30s, then:
   - Load session state, check phase is `IDLE`
   - If idle: spawn `claude --continue -p "Read .entire/REVIEW.md. Apply each suggestion. When done, delete .entire/REVIEW.md." --setting-sources ""`
   - `--setting-sources ""` disables all hooks on the automated process — prevents recursive wingman triggers and session state conflicts
   - If not idle (user is active): exit, leave REVIEW.md for notification

### 4. Detached subprocess spawner

**New file: `cmd/entire/cli/wingman_spawn_unix.go`** (`//go:build unix`)
**New file: `cmd/entire/cli/wingman_spawn_other.go`** (`//go:build !unix`)

Follow exact pattern from `telemetry/detached_unix.go`:
- `os.Executable()` to get own binary
- `Setpgid: true` for process group detachment
- `cmd.Start()` + `Process.Release()`
- Non-unix stub is a no-op (log warning)

### 5. Hook integration (stop hook trigger)

**File: `cmd/entire/cli/hooks_claudecode_handlers.go`**

After `transitionSessionTurnEnd(sessionID)` in `commitWithMetadata()` (~line 378):

```go
if totalChanges > 0 && settings.IsWingmanEnabled() {
    // triggerWingmanReview checks for pending REVIEW.md and dedup internally
    triggerWingmanReview(WingmanPayload{
        SessionID:     sessionID,
        RepoRoot:      repoRoot,
        ModifiedFiles: relModifiedFiles,
        NewFiles:      relNewFiles,
        DeletedFiles:  relDeletedFiles,
        Prompts:       allPrompts,
        CommitMessage: commitMessage,
    })
}
```

`triggerWingmanReview` (in wingman.go):
1. Check if `.entire/REVIEW.md` already exists — skip if a pending review hasn't been applied yet
2. Check deduplication: compute SHA256 of sorted file paths, compare against `.entire/wingman-state.json`. Skip if same hash (already reviewed these exact changes).
3. Marshal payload to JSON
4. Call `spawnDetachedWingmanReview(jsonStr)`
5. Print to stderr: `"[wingman] Review starting in background...\n"`

### 6. Notification on next prompt (fallback)

**File: `cmd/entire/cli/hooks_claudecode_handlers.go`**

In `captureInitialState()`, after existing logic:

```go
if settings.IsWingmanEnabled() {
    if _, err := os.Stat(filepath.Join(repoRoot, ".entire", "REVIEW.md")); err == nil {
        fmt.Fprintf(os.Stderr, "[wingman] Review available: .entire/REVIEW.md — review and apply suggestions\n")
    }
}
```

### 7. Review prompt template

**New file: `cmd/entire/cli/wingman_prompt.go`**

Prompt instructs Claude to act as a senior code reviewer. Key elements:
- User's intent (from prompts/commit message)
- Full code diff
- File change list
- Checkpoint context for understanding "why"

Output format: structured Markdown with severity levels (`CRITICAL` / `WARNING` / `SUGGESTION`), file paths, line numbers, descriptions, and fix suggestions.

### 8. Deduplication & state tracking

**State file: `.entire/wingman-state.json`**

```json
{
  "session_id": "...",
  "files_hash": "sha256-of-sorted-file-paths",
  "reviewed_at": "2026-02-11T...",
  "review_applied": false
}
```

- Before spawning review: skip if `files_hash` matches current
- After writing REVIEW.md: update state
- `.entire/wingman-state.json` is already inside `.entire/` (gitignored)

### 9. Loop-breaking mechanism

The `--setting-sources ""` flag on the auto-apply `claude --continue` call disables all Claude Code hooks (including Entire's stop hook). This means:
- No `commitWithMetadata()` fires after the auto-apply turn
- No wingman trigger, no infinite loop
- The file edits are still in the working directory
- The next human-initiated turn will checkpoint them normally

### 10. Tests

**New file: `cmd/entire/cli/wingman_test.go`**
- Settings parsing (`IsWingmanEnabled` with various configs)
- Dedup logic (files hash computation, skip-if-same-hash)
- Review prompt building (correct template interpolation, diff truncation)
- Payload serialization/deserialization round-trip
- `triggerWingmanReview` skips when disabled / when dedup matches

**File: `cmd/entire/cli/settings/settings_test.go`** (if exists)
- `IsWingmanEnabled()` with strategy_options variations

## Files Summary

| Action | File | Purpose |
|--------|------|---------|
| Create | `cmd/entire/cli/wingman.go` | Command group, payload types, trigger, dedup, review runner |
| Create | `cmd/entire/cli/wingman_prompt.go` | Review prompt template |
| Create | `cmd/entire/cli/wingman_spawn_unix.go` | Detached process spawner (unix) |
| Create | `cmd/entire/cli/wingman_spawn_other.go` | Detached process spawner (stub) |
| Create | `cmd/entire/cli/wingman_test.go` | Unit tests |
| Modify | `cmd/entire/cli/settings/settings.go` | Add `IsWingmanEnabled()` |
| Modify | `cmd/entire/cli/root.go` | Register `newWingmanCmd()` |
| Modify | `cmd/entire/cli/hooks_claudecode_handlers.go` | Trigger wingman + REVIEW.md notification |

## Existing code to reuse

- `summarize/claude.go` — `stripGitEnv()`, Claude CLI invocation pattern, JSON response parsing
- `telemetry/detached_unix.go` — detached subprocess spawn pattern
- `settings/settings.go` — `IsSummarizeEnabled()` pattern for feature flags
- `session/phase.go` — Phase check (IDLE detection for auto-apply timing)
- `strategy.LoadSessionState()` — Read session phase from `.git/entire-sessions/`

## Edge cases

- **Claude CLI not installed**: Detached subprocess catches `exec.Error`, logs to `.entire/logs/`, exits silently
- **Large diffs**: Truncate diff at ~100KB in the prompt to keep review quality high
- **Race with user**: 30s delay + phase check prevents conflicts; if user starts typing, auto-apply is skipped
- **Multiple concurrent sessions**: Each session has its own session ID in the payload; dedup is per-session

## Verification

1. `mise run fmt && mise run lint && mise run test:ci` — all pass
2. Manual test: enable wingman, make a change with Claude, verify:
   - `.entire/REVIEW.md` appears after ~10s
   - Review contains structured feedback referencing the actual diff
   - After ~30s (if idle), Claude auto-resumes and applies suggestions
   - REVIEW.md is deleted after application
   - No infinite loop (next stop hook does not re-trigger wingman for same files)
3. Test fallback: start typing before 30s elapses, verify REVIEW.md notification appears on next prompt-submit


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/dip/.REDACTED.jsonl

---

Are all tests passing?

---

Commit the changes

---

Look at the @.entire/REVIEW.md, check if it's valid feedback and resolve if necessary.

---

Commit and empty the REVIEW.md file.

---

There's new feedback in @.entire/REVIEW.md make sure you review it carefully for validity first before continuing to solve any of it.

---

This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation.

Analysis:
Let me chronologically analyze the conversation:

1. **Initial Request**: User provided a detailed implementation plan for "Entire Wingman" - an automated code review feature for the CLI. The plan was comprehensive with architecture, file changes, and implementation steps.

2. **Exploration Phase**: I read multiple existing files to understand patterns:
   - `settings/settings.go` - for `IsSummarizeEnabled()` pattern
   - `root.go` - for command registration
   - `hooks_claudecode_handlers.go` - for hook integration points
   - `telemetry/detached_unix.go` and `detached_other.go` - for detached subprocess pattern
   - `summarize/claude.go` - for Claude CLI invocation pattern, `stripGitEnv`
   - `config.go` - for settings loading pattern
   - `strategy/session_state.go` - for session state management
   - `session/state.go` - for State struct definition
   - `session/phase.go` - for PhaseIdle constant

3. **Implementation Phase**: Created 6 new files and modified 3 existing files:
   - Settings support (IsWingmanEnabled)
   - Command group (enable/disable/status)
   - Review logic (__review hidden command)
   - Prompt template
   - Detached spawners (unix + other)
   - Hook integration
   - Root command registration
   - Tests

4. **First lint issues**: 
   - `gosec` on os.Remove
   - `noctx` - needed exec.CommandContext instead of exec.Command
   - `wrapcheck` - needed to wrap errors from external packages
   - Missing `encoding/hex` import after linter auto-changed `fmt.Sprintf("%x", h)` to `hex.EncodeToString`

5. **Test failure**: `TestWingmanState_SaveLoad` failed because `paths.AbsPath` requires a real git repo. Fixed by using `git init` instead of just creating `.git` directory.

6. **Second lint run**: Test file had `exec.Command` instead of `exec.CommandContext`. Fixed.

7. **All tests passed** (unit + integration + race detection).

8. **User asked "Are all tests passing?"** - I ran full CI suite, found noctx lint issue in test, fixed it, all green.

9. **User asked to "Commit the changes"** - Before committing, I noticed unrelated strategy file changes (nolint comment removals by linter), started to revert them.

10. **User interrupted**: "Write the plan to a temporary Plan file, don't commit." - I wrote `.entire/WINGMAN_PLAN.md` and skipped the commit.

11. **First REVIEW.md appeared** (system reminder showed its content). User asked me to review it. Two issues:
    - WARNING: No locking between dedup check and spawn (TOCTOU race)
    - WARNING: `computeDiff` uses HEAD at review time, not trigger time
    
    Both valid. I fixed them:
    - Added lock file with `Stat()` check before spawning
    - Added `BaseCommit` field to payload, captured HEAD at trigger time
    - Updated `computeDiff` to accept and use baseCommit parameter

12. **User asked "Commit and empty the REVIEW.md file"** - I reverted unrelated strategy changes, staged wingman files, committed as `d13528a1`, then emptied REVIEW.md.

13. **Second REVIEW.md appeared** with 6 issues. User asked me to "review it carefully for validity first before continuing to solve any of it." I evaluated all 6:
    1. CRITICAL: Lock file TOCTOU race (Stat+WriteFile) - Valid
    2. CRITICAL: No timeouts on Claude CLI calls - Valid
    3. WARNING: Payload as CLI arg can exceed argv limit - Valid
    4. WARNING: os.Chdir mutates process-wide state - Valid
    5. WARNING: Stale lock never cleaned on crash - Valid
    6. SUGGESTION: Dedup hash newline ambiguity - Valid (trivial fix)

14. **I applied all 6 fixes**:
    - Fix 1: Atomic `O_CREATE|O_EXCL` lock acquisition via `acquireWingmanLock()`
    - Fix 2: Timeouts on all Claude CLI and git diff calls
    - Fix 3: Payload written to temp file, path passed as arg instead of JSON
    - Fix 4: Replaced `os.Chdir` with `saveWingmanStateDirect()` that writes directly to known path
    - Fix 5: Stale lock detection (30min threshold) in `acquireWingmanLock()`
    - Fix 6: Null byte separator for hash

15. **Ran lint** - Got 2 errcheck issues:
    - `f.WriteString(sessionID)` in acquireWingmanLock - needs errcheck handling
    - `os.WriteFile(statePath, data, 0o644)` in saveWingmanStateDirect - needs errcheck handling
    
    These are the CURRENT unfixed lint issues.

Let me now identify the current state of each file and pending work.

Current unfixed lint errors:
1. `cmd/entire/cli/wingman.go:265` - `f.WriteString(sessionID)` not checked
2. `cmd/entire/cli/wingman_review.go:301` - `os.WriteFile(statePath, data, 0o644)` not checked

These need `//nolint:errcheck` annotations or explicit `_ =` assignments.

Summary:
1. Primary Request and Intent:
   The user requested implementation of the "Entire Wingman" feature — an automated code review loop for the CLI. After an agent turn modifies files, a background reviewer analyzes changes via Claude, writes suggestions to `.entire/REVIEW.md`, and after a delay, triggers the agent to auto-apply suggestions. The plan was provided in full detail. Subsequently, the user requested reviewing auto-generated `REVIEW.md` feedback files (twice), applying valid suggestions, committing changes, and emptying REVIEW.md. The user explicitly told me to "Write the plan to a temporary Plan file, don't commit" when I was about to commit initially.

2. Key Technical Concepts:
   - Go CLI with cobra/huh frameworks
   - Detached subprocess spawning (Unix process group detachment via `Setpgid`)
   - Claude CLI invocation (`claude --print --output-format json --model sonnet --setting-sources ""`)
   - Loop-breaking via `--setting-sources ""` disabling all hooks
   - Session phase state machine (IDLE detection for auto-apply timing)
   - Git environment isolation (`stripGitEnv` pattern from `summarize/claude.go`)
   - Settings feature flags (`strategy_options.wingman.enabled`)
   - Atomic file locking with `O_CREATE|O_EXCL`
   - Stale lock detection via file modtime
   - Payload file instead of CLI argument to avoid argv limits
   - SHA256 dedup hashing with null-byte separator
   - Context timeouts on external process calls

3. Files and Code Sections:

   - **`cmd/entire/cli/settings/settings.go`** (modified)
     - Added `IsWingmanEnabled()` package-level function and method on `EntireSettings`, following `IsSummarizeEnabled()` pattern
     - Reads `strategy_options.wingman.enabled` from settings
     ```go
     func IsWingmanEnabled() bool {
         s, err := Load()
         if err != nil { return false }
         return s.IsWingmanEnabled()
     }
     func (s *EntireSettings) IsWingmanEnabled() bool {
         if s.StrategyOptions == nil { return false }
         wingmanOpts, ok := s.StrategyOptions["wingman"].(map[string]any)
         if !ok { return false }
         enabled, ok := wingmanOpts["enabled"].(bool)
         if !ok { return false }
         return enabled
     }
     ```

   - **`cmd/entire/cli/wingman.go`** (created)
     - Core command group (enable/disable/status), payload types, trigger logic, dedup, state management, atomic lock acquisition
     - Key types: `WingmanPayload` (with `BaseCommit` field), `WingmanState`
     - `triggerWingmanReview()` — checks REVIEW.md existence, acquires atomic lock, captures HEAD, writes payload to file, spawns detached process
     - `acquireWingmanLock()` — atomic `O_CREATE|O_EXCL` with 30min stale lock cleanup
     - `computeFilesHash()` — SHA256 with null-byte separator
     - `resolveHEAD()` — captures HEAD hash at trigger time
     - Currently has lint error on line 265: `f.WriteString(sessionID)` not checked

   - **`cmd/entire/cli/wingman_review.go`** (created)
     - Hidden `__review` command — the detached worker process
     - `runWingmanReview()` — reads payload from file, sleeps 10s, computes diff, calls Claude for review, writes REVIEW.md, updates state, waits 30s, checks idle, triggers auto-apply
     - `computeDiff()` — uses baseCommit from trigger time, has 60s git timeout
     - `callClaudeForReview()` — 5min timeout, isolated from git
     - `triggerAutoApply()` — 15min timeout, `claude --continue -p`
     - `saveWingmanStateDirect()` — writes state directly without `os.Chdir`
     - `wingmanStripGitEnv()` — strips GIT_* env vars
     - Currently has lint error on line 301: `os.WriteFile` not checked in `saveWingmanStateDirect`

   - **`cmd/entire/cli/wingman_prompt.go`** (created)
     - Review prompt template with XML boundary tags for security
     - `buildReviewPrompt()` — builds prompt from prompts, file list, diff
     - `maxDiffSize = 100KB` — truncation for large diffs

   - **`cmd/entire/cli/wingman_spawn_unix.go`** (created)
     - Unix detached process spawner following `telemetry/detached_unix.go` pattern
     - Takes `payloadPath` (file path, not JSON string)
     - `Setpgid: true`, `cmd.Dir = "/"`, stdout/stderr discarded

   - **`cmd/entire/cli/wingman_spawn_other.go`** (created)
     - No-op stub for non-Unix platforms

   - **`cmd/entire/cli/wingman_test.go`** (created)
     - Tests: hash determinism, hash ordering, hash different files, hash empty, payload round-trip (including BaseCommit), prompt sections, prompt empty, prompt truncation, state save/load (with real git init), stripGitEnv, IsWingmanEnabled settings (7 subtests)

   - **`cmd/entire/cli/root.go`** (modified)
     - Added `cmd.AddCommand(newWingmanCmd())` after `newCurlBashPostInstallCmd()`

   - **`cmd/entire/cli/hooks_claudecode_handlers.go`** (modified)
     - Added `settings` import
     - In `captureInitialState()`: REVIEW.md notification check
     - In `commitWithMetadata()` after `transitionSessionTurnEnd()`: wingman trigger when `totalChanges > 0 && settings.IsWingmanEnabled()`

   - **`.entire/WINGMAN_PLAN.md`** (created)
     - Detailed implementation plan document

4. Errors and Fixes:
   - **gosec on `os.Remove`**: Added `_ = os.Remove(reviewPath) //nolint:gosec`
   - **noctx lint (5 instances)**: Changed all `exec.Command()` to `exec.CommandContext()` with appropriate contexts
   - **wrapcheck (7 instances)**: Wrapped all error returns from external packages with `fmt.Errorf("context: %w", err)`
   - **Missing `encoding/hex` import**: Linter auto-changed `fmt.Sprintf("%x", h)` to `hex.EncodeToString(h[:])`, needed to add the import
   - **Test failure `TestWingmanState_SaveLoad`**: `paths.AbsPath` needs a real git repo, not just `.git` directory. Fixed by using `exec.CommandContext(ctx, "git", "init", tmpDir)` instead of `os.MkdirAll(".git")`
   - **noctx in test**: Changed `exec.Command("git", "init")` to `exec.CommandContext(context.Background(), "git", "init")`
   - **Unrelated strategy file changes**: Linter removed `//nolint:ireturn` comments from strategy files. Reverted with `git checkout --` before committing.
   - **REVIEW.md round 1 (2 warnings)**: Lock file TOCTOU + HEAD drift. Fixed with lock file + BaseCommit field.
   - **REVIEW.md round 2 (6 issues)**: All valid. Applied fixes for atomic locking, timeouts, payload file, direct state write, stale lock cleanup, null-byte separator.
   - **CURRENT: 2 errcheck lint errors** after applying round 2 fixes:
     - `wingman.go:265`: `_, _ = f.WriteString(sessionID)` flagged by errcheck
     - `wingman_review.go:301`: `_ = os.WriteFile(statePath, data, 0o644)` flagged by errcheck

5. Problem Solving:
   - Solved pattern discovery by reading existing `telemetry/detached_unix.go`, `summarize/claude.go`, `settings.go` for established conventions
   - Solved import cycle awareness by using `settings` package (not `cli`) for wingman settings
   - Solved TOCTOU lock race with atomic `O_CREATE|O_EXCL` file creation
   - Solved HEAD drift by capturing commit hash at trigger time in payload
   - Solved argv limit risk by writing payload to temp file
   - Solved process-global state mutation by removing `os.Chdir` in favor of direct path construction
   - Solved stale lock issue with modtime-based threshold (30min)
   - Two errcheck lint errors remain unfixed

6. All User Messages:
   - "Implement the following plan: [detailed wingman plan]"
   - "Are all tests passing?"
   - "Commit the changes"
   - "Write the plan to a temporary Plan file, don't commit." (interruption while committing)
   - "Look at the @.entire/REVIEW.md, check if it's valid feedback and resolve if necessary."
   - "Commit and empty the REVIEW.md file."
   - "There's new feedback in @.entire/REVIEW.md make sure you review it carefully for validity first before continuing to solve any of it."

7. Pending Tasks:
   - Fix 2 remaining errcheck lint errors in `wingman.go:265` and `wingman_review.go:301`
   - Run `mise run fmt && mise run lint && mise run test:ci` to verify all green
   - The REVIEW.md needs to be emptied (user's previous pattern was to empty it after applying feedback)

8. Current Work:
   I was applying all 6 fixes from the second REVIEW.md. I made all code changes and ran `mise run fmt && mise run lint` which revealed 2 remaining errcheck lint errors:
   
   Error 1 - `cmd/entire/cli/wingman.go:265`:
   ```go
   _, _ = f.WriteString(sessionID)
   ```
   The linter flags the errcheck despite the `_, _ =` pattern.
   
   Error 2 - `cmd/entire/cli/wingman_review.go:301`:
   ```go
   _ = os.WriteFile(statePath, data, 0o644)
   ```
   The linter flags the errcheck despite the `_ =` pattern.
   
   Both need `//nolint:errcheck` annotations to satisfy the linter, since these are intentionally best-effort operations.

9. Optional Next Step:
   Fix the 2 errcheck lint errors by adding `//nolint:errcheck` comments, then run the full `mise run fmt && mise run lint && mise run test:ci` to verify clean. This is directly continuing the work from the user's request: "There's new feedback in @.entire/REVIEW.md make sure you review it carefully for validity first before continuing to solve any of it." — I evaluated all 6 issues as valid, applied all fixes, and was in the process of verifying the fixes pass lint when the summary was requested.

If you need specific details from before compaction (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/dip/.claude/projects/-Users-dip-Repositories-cli/6dccd523-72ba-4cb2-b043-2422d5fa2cda.jsonl
Please continue the conversation from where we left off without asking the user any further questions. Continue with the last task that you were asked to work on.

---

Clear the Review file. Then let's add some sort of log output to the wingman command for debuggin purposes. I would like to verfiy each step happening in the background. What would you propose? That said, it's currently not working.

---

Go ahead.

---

Commit the changes we have so far