can you check In CalculateAttributionWithAccumulated, TotalCommitted and AgentLines don't account for user removals of agent lines. When a user removes lines the agent added, totalCommitted is calculated as totalAgentAdded + pureUserAdded without subtracting pureUserRemoved. For example, if the agent adds 10 lines and the user removes 5 of them and adds 2 new ones, the commit has 7 net lines but TotalCommitted reports 10, and AgentPercentage reports 100% instead of ~71%. The simpler CalculateAttribution function correctly uses the actual commit diff for this calculation, but the production function does not.

---

can you fix it?

---

are there tests for CalculateAttributionWithAccumulated?

---

yes, all 3

---

commit these changes

---

[Request interrupted by user]

---

After condensation in PostCommit, state.PromptAttributions and state.PendingPromptAttribution are not cleared. When CheckpointCount is reset to 0 but PromptAttributions retains old entries, subsequent checkpoints append new entries to the existing list. On the next condensation, CalculateAttributionWithAccumulated sums ALL entries including ones from prior condensations, causing user edits to be double-counted in the attribution calculation.

---

[Request interrupted by user]

---

After condensation in PostCommit, state.PromptAttributions and state.PendingPromptAttribution are not cleared. When CheckpointCount is reset to 0 but PromptAttributions retains old entries, subsequent checkpoints append new entries to the existing list. On the next condensation, CalculateAttributionWithAccumulated sums ALL entries including ones from prior condensations, causing user edits to be double-counted in the attribution calculation.

---

The RunGitCommand function is defined in testenv.go but never called anywhere in the codebase. A grep for env.RunGitCommand or .RunGitCommand returns no matches, indicating this is dead code that adds unnecessary maintenance burden.

---

The exported CalculateAttribution function is only used in unit tests within the same package (manual_commit_attribution_test.go). Production code exclusively uses CalculateAttributionWithAccumulated for attribution calculations (called from manual_commit_condensation.go). This appears to be an older implementation that was superseded but not removed.